<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Payment</title>
    <meta name="description" content="Complete your subscription with secure payment processing">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <script src="https://js.stripe.com/v3/"></script>
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="nav-container">
                <div class="logo">
                    <h1>Payment Portal</h1>
                </div>
                <nav class="nav-links">
                    <a href="dashboard.html">Dashboard</a>
                    <a href="pricing.html">Pricing</a>
                    <a href="auth.html">Login</a>
                </nav>
            </div>
        </header>

        <main class="payment-main">
            <div class="payment-container">
                <div class="payment-header">
                    <div class="progress-indicator">
                        <div class="step completed">
                            <span class="step-number">1</span>
                            <span class="step-label">Plan Selection</span>
                        </div>
                        <div class="step-connector"></div>
                        <div class="step active">
                            <span class="step-number">2</span>
                            <span class="step-label">Payment</span>
                        </div>
                        <div class="step-connector"></div>
                        <div class="step">
                            <span class="step-number">3</span>
                            <span class="step-label">Confirmation</span>
                        </div>
                    </div>
                    <h1>Complete Your Purchase</h1>
                    <p class="payment-subtitle">Secure payment powered by <strong>Stripe</strong> • SSL encrypted</p>
                </div>

                <div class="payment-layout">
                    <!-- Left Column: Payment Form -->
                    <div class="payment-form-section">
                        <div class="payment-form-container">
                            <form id="payment-form" novalidate>
                                <div class="form-section">
                                    <h2>Payment Information</h2>
                                    
                                    <!-- Credit Card Information -->
                                    <div class="form-group">
                                        <label for="cardholder-name">Cardholder Name *</label>
                                        <input type="text" id="cardholder-name" name="cardholder-name" 
                                               placeholder="John Doe" required autocomplete="cc-name"
                                               class="form-input">
                                        <div id="cardholder-name-errors" class="error-message" role="alert" aria-live="polite"></div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="card-number">Card Number *</label>
                                        <div id="card-number" class="stripe-element">
                                            <!-- Stripe Elements will create card number field here -->
                                        </div>
                                        <!-- Fallback input for when Stripe is not available -->
                                        <input type="text" id="card-number-fallback" class="fallback-input" 
                                               placeholder="1234 5678 9012 3456" maxlength="19" 
                                               style="display: none;" autocomplete="cc-number">
                                        <div id="card-number-errors" class="error-message" role="alert" aria-live="polite"></div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group half-width">
                                            <label for="card-expiry">Expiration Date *</label>
                                            <div id="card-expiry" class="stripe-element">
                                                <!-- Stripe Elements will create expiry field here -->
                                            </div>
                                            <!-- Fallback input for when Stripe is not available -->
                                            <input type="text" id="card-expiry-fallback" class="fallback-input" 
                                                   placeholder="MM/YY" maxlength="5" 
                                                   style="display: none;" autocomplete="cc-exp">
                                            <div id="card-expiry-errors" class="error-message" role="alert" aria-live="polite"></div>
                                        </div>
                                        <div class="form-group half-width">
                                            <label for="card-cvc">Security Code (CVV) *</label>
                                            <div id="card-cvc" class="stripe-element">
                                                <!-- Stripe Elements will create CVC field here -->
                                            </div>
                                            <!-- Fallback input for when Stripe is not available -->
                                            <input type="text" id="card-cvc-fallback" class="fallback-input" 
                                                   placeholder="123" maxlength="4" 
                                                   style="display: none;" autocomplete="cc-csc">
                                            <div id="card-cvc-errors" class="error-message" role="alert" aria-live="polite"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h3>Billing Information</h3>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="email">Email Address *</label>
                                            <input type="email" id="email" name="email" required autocomplete="email" 
                                                   placeholder="your@email.com" aria-describedby="email-error">
                                            <div id="email-error" class="error-message" role="alert"></div>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="name">Full Name *</label>
                                            <input type="text" id="name" name="name" required autocomplete="name" 
                                                   placeholder="John Doe" aria-describedby="name-error">
                                            <div id="name-error" class="error-message" role="alert"></div>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="address">Address *</label>
                                            <input type="text" id="address" name="address" required autocomplete="street-address" 
                                                   placeholder="123 Main Street" aria-describedby="address-error">
                                            <div id="address-error" class="error-message" role="alert"></div>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group half-width">
                                            <label for="city">City *</label>
                                            <input type="text" id="city" name="city" required autocomplete="address-level2" 
                                                   placeholder="New York" aria-describedby="city-error">
                                            <div id="city-error" class="error-message" role="alert"></div>
                                        </div>
                                        <div class="form-group quarter-width">
                                            <label for="state">State *</label>
                                            <input type="text" id="state" name="state" required autocomplete="address-level1" 
                                                   placeholder="NY" aria-describedby="state-error">
                                            <div id="state-error" class="error-message" role="alert"></div>
                                        </div>
                                        <div class="form-group quarter-width">
                                            <label for="zip">ZIP Code *</label>
                                            <input type="text" id="zip" name="zip" required autocomplete="postal-code" 
                                                   placeholder="10001" aria-describedby="zip-error">
                                            <div id="zip-error" class="error-message" role="alert"></div>
                                        </div>
                                    </div>
                                </div>

                                <button type="submit" id="submit-button" class="payment-submit-btn" aria-describedby="submit-status">
                                    <span id="button-text">Complete Payment</span>
                                    <div id="spinner" class="spinner hidden" aria-hidden="true"></div>
                                </button>
                                <div id="submit-status" class="sr-only" aria-live="polite"></div>
                            </form>
                        </div>
                    </div>

                    <!-- Right Column: Order Summary -->
                    <div class="order-summary-section">
                        <div class="order-summary">
                            <h3>Order Summary</h3>
                            <div class="selected-plan" id="selectedPlan">
                                <div class="plan-header">
                                    <h4 id="planName">Pro Plan</h4>
                                    <button class="change-plan-btn" onclick="window.location.href='pricing.html'" 
                                            aria-label="Change selected plan">
                                        <span>Change</span>
                                    </button>
                                </div>
                                <p id="planDescription" class="plan-desc">2,000 credits per month</p>
                                <div class="plan-features" id="planFeatures">
                                    <ul>
                                        <li>2,000 credits monthly</li>
                                        <li>Advanced AI models</li>
                                        <li>Priority support</li>
                                        <li>Export to multiple formats</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="pricing-breakdown">
                                <div class="summary-row">
                                    <span>Subtotal:</span>
                                    <span id="subtotal">$9.99</span>
                                </div>
                                <div class="summary-row">
                                    <span>Tax:</span>
                                    <span id="tax">$0.00</span>
                                </div>
                                <div class="summary-row total">
                                    <span>Total:</span>
                                    <div class="total-price">
                                        <span id="total">$9.99</span>
                                        <span id="billingCycle" class="billing-cycle">/month</span>
                                    </div>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>



                <!-- Security Info -->
                <div class="security-info">
                    <div class="security-badges">
                        <div class="badge">
                            <span class="icon">🔒</span>
                            <span>256-bit SSL</span>
                        </div>
                        <div class="badge">
                            <span class="icon">💳</span>
                            <span>Stripe Secure</span>
                        </div>
                        <div class="badge">
                            <span class="icon">🛡️</span>
                            <span>PCI DSS Level 1</span>
                        </div>
                        <div class="badge">
                            <span class="icon">🏆</span>
                            <span>SOC 2 Compliant</span>
                        </div>
                    </div>
                    <p class="security-text">Your payment information is encrypted and secure. We never store your credit card details. Powered by Stripe, trusted by millions worldwide.</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Initialize Stripe with error handling
        let stripe, elements, cardNumberElement, cardExpiryElement, cardCvcElement;
        let useStripe = false;
        
        try {
            // TODO: Replace with actual Stripe publishable key
            stripe = Stripe('pk_test_your_stripe_publishable_key_here');
            elements = stripe.elements();
            useStripe = true;
        } catch (error) {
            console.warn('Stripe failed to initialize, using fallback inputs:', error);
            useStripe = false;
        }
        
        // Additional check: if Stripe key is invalid, it will fail during element creation
        if (useStripe && stripe && elements) {
            // Test if we can create elements with this key
            try {
                const testElement = elements.create('cardNumber');
                testElement.destroy(); // Clean up test element
            } catch (error) {
                console.warn('Stripe key appears to be invalid, using fallback inputs:', error);
                useStripe = false;
            }
        }

        // Create and mount card elements or show fallback inputs
        if (useStripe && elements) {
            try {
                cardNumberElement = elements.create('cardNumber', {
                    style: {
                        base: {
                            fontSize: '16px',
                            color: '#424770',
                            '::placeholder': {
                                color: '#aab7c4',
                            },
                        },
                    },
                });

                cardExpiryElement = elements.create('cardExpiry', {
                    style: {
                        base: {
                            fontSize: '16px',
                            color: '#424770',
                            '::placeholder': {
                                color: '#aab7c4',
                            },
                        },
                    },
                });

                cardCvcElement = elements.create('cardCvc', {
                    style: {
                        base: {
                            fontSize: '16px',
                            color: '#424770',
                            '::placeholder': {
                                color: '#aab7c4',
                            },
                        },
                    },
                });

                // Mount the elements
                cardNumberElement.mount('#card-number');
                cardExpiryElement.mount('#card-expiry');
                cardCvcElement.mount('#card-cvc');
            } catch (error) {
                console.warn('Failed to create Stripe elements, using fallback:', error);
                useStripe = false;
            }
        }
        
        // Show fallback inputs if Stripe is not available
        function showFallbackInputs() {
            document.getElementById('card-number-fallback').style.display = 'block';
            document.getElementById('card-expiry-fallback').style.display = 'block';
            document.getElementById('card-cvc-fallback').style.display = 'block';
            
            // Hide Stripe element containers
            document.getElementById('card-number').style.display = 'none';
            document.getElementById('card-expiry').style.display = 'none';
            document.getElementById('card-cvc').style.display = 'none';
        }
        
        if (!useStripe) {
            showFallbackInputs();
        }
        
        // Fallback timeout - show inputs after 2 seconds if Stripe hasn't loaded
        setTimeout(() => {
            if (!useStripe || !cardNumberElement) {
                console.log('Stripe elements not ready, showing fallback inputs');
                showFallbackInputs();
            }
        }, 2000);

        // Handle real-time validation errors from the card elements (only if Stripe is available)
        if (useStripe && cardNumberElement && cardExpiryElement && cardCvcElement) {
            cardNumberElement.on('change', ({error}) => {
                const displayError = document.getElementById('card-number-errors');
                if (error) {
                    displayError.textContent = error.message;
                } else {
                    displayError.textContent = '';
                }
            });

            cardExpiryElement.on('change', ({error}) => {
                const displayError = document.getElementById('card-expiry-errors');
                if (error) {
                    displayError.textContent = error.message;
                } else {
                    displayError.textContent = '';
                }
            });

            cardCvcElement.on('change', ({error}) => {
                const displayError = document.getElementById('card-cvc-errors');
                if (error) {
                    displayError.textContent = error.message;
                } else {
                    displayError.textContent = '';
                }
            });
        }

        // Add validation for cardholder name
        const cardholderNameInput = document.getElementById('cardholder-name');
        const cardholderNameErrors = document.getElementById('cardholder-name-errors');
        
        cardholderNameInput.addEventListener('blur', () => {
            const name = cardholderNameInput.value.trim();
            if (!name) {
                cardholderNameErrors.textContent = 'Cardholder name is required';
            } else if (name.length < 2) {
                cardholderNameErrors.textContent = 'Please enter a valid name';
            } else {
                cardholderNameErrors.textContent = '';
            }
        });

        // Handle form submission
        const form = document.getElementById('payment-form');
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            // Validate cardholder name before processing
            const cardholderName = cardholderNameInput.value.trim();
            if (!cardholderName) {
                cardholderNameErrors.textContent = 'Cardholder name is required';
                cardholderNameInput.focus();
                return;
            }

            const submitButton = document.getElementById('submit-button');
            const buttonText = document.getElementById('button-text');
            const spinner = document.getElementById('spinner');

            // Show loading state
            submitButton.disabled = true;
            buttonText.textContent = 'Processing...';
            spinner.classList.remove('hidden');

            // Get plan details from URL parameters or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            const planType = urlParams.get('plan') || 'pro';

            try {
                // TODO: Implement Stripe payment processing
                // This is where you would:
                // 1. Create payment intent on your server
                // 2. Confirm payment with Stripe
                // 3. Handle successful payment
                // 4. Redirect to success page

                /*
                Example Stripe integration:
                
                const {error, paymentIntent} = await stripe.confirmCardPayment(
                    clientSecret, // Obtained from your server
                    {
                        payment_method: {
                            card: cardNumberElement,
                            billing_details: {
                                name: document.getElementById('cardholder-name').value,
                                email: document.getElementById('email').value,
                                address: {
                                    line1: document.getElementById('address').value,
                                    city: document.getElementById('city').value,
                                    state: document.getElementById('state').value,
                                    postal_code: document.getElementById('zip').value,
                                }
                            }
                        }
                    }
                );

                if (error) {
                    // Show error to customer
                    showError(error.message);
                } else {
                    // Payment succeeded
                    window.location.href = 'payment-success.html?payment_intent=' + paymentIntent.id;
                }
                */

                // Temporary simulation for demo purposes
                setTimeout(() => {
                    alert('Payment simulation - this would integrate with Stripe in production');
                    window.location.href = 'dashboard.html';
                }, 2000);

            } catch (error) {
                console.error('Payment error:', error);
                showError('An unexpected error occurred. Please try again.');
            } finally {
                // Reset button state
                submitButton.disabled = false;
                buttonText.textContent = 'Complete Payment';
                spinner.classList.add('hidden');
            }
        });

        function showError(message) {
            const errorElement = document.getElementById('card-errors');
            errorElement.textContent = message;
        }

        // Load plan details based on URL parameters
        function loadPlanDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const planType = urlParams.get('plan') || 'pro';

            const plans = {
                free: {
                    name: 'Freemium Plan',
                    description: '200 credits per month',
                    price: '$0.00',
                    cycle: '/month',
                    features: [
                        '200 credits monthly',
                        'Basic AI models',
                        'Standard support',
                        'Basic export options'
                    ]
                },
                pro: {
                    name: 'Pro Plan',
                    description: '2,000 credits per month',
                    price: '$9.99',
                    cycle: '/month',
                    features: [
                        '2,000 credits monthly',
                        'Advanced AI models',
                        'Priority support',
                        'Export to multiple formats'
                    ]
                },
                custom: {
                    name: 'Custom Plan',
                    description: 'Pay per usage',
                    price: '$15.00',
                    cycle: '/usage',
                    features: [
                        '$1 = 220 credits',
                        'Premium AI models',
                        'Dedicated support',
                        'Advanced analytics'
                    ]
                }
            };

            const plan = plans[planType] || plans.pro;
            
            // Update plan details with error handling
            const updateElement = (id, content) => {
                const element = document.getElementById(id);
                if (element) element.textContent = content;
            };
            
            updateElement('planName', plan.name);
            updateElement('planDescription', plan.description);
            updateElement('subtotal', plan.price);
            updateElement('total', plan.price);
            updateElement('billingCycle', plan.cycle);

            // Update features list
            const featuresList = document.querySelector('#planFeatures ul');
            if (featuresList) {
                featuresList.innerHTML = '';
                plan.features.forEach(feature => {
                    const li = document.createElement('li');
                    li.textContent = feature;
                    featuresList.appendChild(li);
                });
            }
            
            // Update page title
            document.title = `${plan.name} - Secure Payment - AI Writing Assistant`;
        }

        // Load plan details on page load
        document.addEventListener('DOMContentLoaded', loadPlanDetails);
    </script>

    
</body>
</html>